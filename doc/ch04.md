# Chapter 04 创建社交网站


在上一章我们学习了如何创建站点地图和信息流，并且为博客应用构建了搜索引擎。在这一章里，我们将开发社交网站，为用户创建登录、登出、修改和重置密码的功能，学习如何为我们的用户创建自定义的用户属性，为站点添加社交认证。

本章将涵盖以下内容：
- 使用认证框架
- 创建用户注册视图
- 使用自定义属性模型扩展`User`模型
- 使用`python-social-auth`添加社交认证

让我们开始创建新项目吧。

## 创建一个社交网站项目

我们将要创建社交网站，允许用户分享在互联网上找到的图片，我们需要为项目创建以下几方面的内容：
- 用于用户注册、登录、编辑属性、修改和重置密码的认证系统
- 允许用户相互关注的系统
- 为用户从任何网站分享过来的图片进行展示和打上标签
- 每个用户都有一个活动流，并允许他们看到所关注的用户上传的内容

本章阐述第一点。

### 开始我们的社交网站项目

- 为项目创建虚拟环境并激活它：
```
mkdir env
virtualenv env/bookmarks
source env/bookmarks/bin/activate
```
- 安装Django
```
pip install django
```
- 创建项目
```
django-admin startproject bookmarks
```
- 进入项目目录，创建一个应用
```
cd bookmarks/
django-admin startapp account
```
- 记得在项目中的`settings.py`文件添加应用到`INSTALLED_APPS`来激活我们的应用，添加在其他应用的前面:
```python
INSTALLED_APPS = [
    'account',
    # ....
]
```
- 运行下面的命令为`INSTALLED_APPS`中默认的应用模型同步到数据库：
```
python manage.py migrate
```
我们将使用认证（authentication）框架来构建认证系统到项目中。

## 使用Django认证（authentication）框架

Django内建的authentication框架可以处理用户认证，会话，权限以及用户组。该认证系统包括了普通用户的操作视图，例如登录、登出、修改和重置密码。

该认证框架位于`django.contrib.auth`，被用于其他的Django `contrib`包。回顾一下我们已经在第一章中使用过认证框架了，为博客项目创建了一个用于访问其管理台的超级用户。

当我们使用`startproject`命令创建一个新的Django项目，认证系统就已经包含在项目默认的设置中了。它由`django.contrib.auth`和项目设置中`MIDDLEWARE_CLASSES`里面的两个中间件类组成：
- `AuthenticationMiddleware`：使用会话`session`关联用户和请求
- `SessionMiddleware`：通过请求处理当前会话

中间件是在请求和响应阶段带有全局执行方法的类。我们将在后面章节的很多场景中使用中间件。在第十三章中学习如何创建自定义的中间件。

认证框架包含以下几个模型：
- `User`：包含基础字段的用户模型，模型中的主要字段有： *username*, *password*, *email*, *first_name*, *last_name*, *is_active*。
- `Group`：用来分类用户的组模型。
- `Permission`：执行特定操作的标识。

该框架也包含了默认视图和表单，稍后我们会用到。

### 创建登录（log-in）视图

我们将使用Django认证框架来让用户登录网站，我们的视图需执行以下的操作来供用户登录：
1. 通过提交表单获取用户名和密码
1. 比对数据库中的数据来认证用户
1. 检查用户是否可用
1. 用户登录到网站，并开启一个认证会话

首先，我们创建一个登录表单（form），在*account*目录下创建*forms.py*文件，并添加如下代码：
```python
from django import forms


class LoginForm(forms.Form):
    username = forms.CharField()
    password = forms.CharField(widget=forms.PasswordInput)
```

这个表单将通过比对数据库来认证用户。请注意，我们使用`PasswordInput`控件来渲染HTML的`input`元素，包含`type="password"`属性。编辑*account*中的*views.py*文件并添加以下代码：

### 使用Django认证视图
### 登录和登出视图
### 修改密码视图
### 重置密码视图

## 用户注册和用户属性
### 用户注册
### 扩展用户模型
#### 使用自定义用户模型
### 使用消息框架
## 创建自定义的认证后台
## 为站点添加社交认证
### 使用Facebook认证
### 使用Twitter认证
### 使用Google认证
## 总结
