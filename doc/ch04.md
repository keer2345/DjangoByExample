# Chapter 04 创建社交网站


在上一章我们学习了如何创建站点地图和信息流，并且为博客应用构建了搜索引擎。在这一章里，我们将开发社交网站，为用户创建登录、登出、修改和重置密码的功能，学习如何为我们的用户创建自定义的用户属性，为站点添加社交认证。

本章将涵盖以下内容：
- 使用认证框架
- 创建用户注册视图
- 使用自定义属性模型扩展`User`模型
- 使用`python-social-auth`添加社交认证

让我们开始创建新项目吧。

## 创建一个社交网站项目

我们将要创建社交网站，允许用户分享在互联网上找到的图片，我们需要为项目创建以下几方面的内容：
- 用于用户注册、登录、编辑属性、修改和重置密码的认证系统
- 允许用户相互关注的系统
- 为用户从任何网站分享过来的图片进行展示和打上标签
- 每个用户都有一个活动流，并允许他们看到所关注的用户上传的内容

本章阐述第一点。

### 开始我们的社交网站项目

- 为项目创建虚拟环境并激活它：
```
mkdir env
virtualenv env/bookmarks
source env/bookmarks/bin/activate
```
- 安装Django
```
pip install django
```
- 创建项目
```
django-admin startproject bookmarks
```
- 进入项目目录，创建一个应用
```
cd bookmarks/
django-admin startapp account
```
- 记得在项目中的`settings.py`文件添加应用到`INSTALLED_APPS`来激活我们的应用，添加在其他应用的前面:
```python
INSTALLED_APPS = [
    'account',
    # ....
]
```
- 运行下面的命令为`INSTALLED_APPS`中默认的应用模型同步到数据库：
```
python manage.py migrate
```
我们将使用认证（authentication）框架来构建认证系统到项目中。

## 使用Django认证（authentication）框架

Django内建的authentication框架可以处理用户认证，会话，权限以及用户组。该认证系统包括了普通用户的操作视图，例如登录、登出、修改和重置密码。

该认证框架位于`django.contrib.auth`，被用于其他的Django `contrib`包。回顾一下我们已经在第一章中使用过认证框架了，为博客项目创建了一个用于访问其管理台的超级用户。

当我们使用`startproject`命令创建一个新的Django项目，认证系统就已经包含在项目默认的设置中了。它由`django.contrib.auth`和项目设置中`MIDDLEWARE_CLASSES`里面的两个中间件类组成：
- `AuthenticationMiddleware`：使用会话`session`关联用户和请求
- `SessionMiddleware`：通过请求处理当前会话

中间件是在请求和响应阶段带有全局执行方法的类。我们将在后面章节的很多场景中使用中间件。在第十三章中学习如何创建自定义的中间件。

认证框架包含以下几个模型：
- `User`：包含基础字段的用户模型，模型中的主要字段有： *username*, *password*, *email*, *first_name*, *last_name*, *is_active*。
- `Group`：用来分类用户的组模型。
- `Permission`：执行特定操作的标识。

该框架也包含了默认视图和表单，稍后我们会用到。

### 创建登录（log-in）视图

我们将使用Django认证框架来让用户登录网站，我们的视图需执行以下的操作来供用户登录：
1. 通过提交表单获取用户名和密码
1. 比对数据库中的数据来认证用户
1. 检查用户是否可用
1. 用户登录到网站，并开启一个认证会话

首先，我们创建一个登录表单（form），在*account*目录下创建*forms.py*文件，并添加如下代码：
```python
from django import forms


class LoginForm(forms.Form):
    username = forms.CharField()
    password = forms.CharField(widget=forms.PasswordInput)
```

这个表单将通过比对数据库来认证用户。请注意，我们使用`PasswordInput`控件来渲染HTML的`input`元素，包含`type="password"`属性。编辑*account*中的*views.py*文件并添加以下代码：
```python
from django.contrib.auth import authenticate, login
from django.http import HttpResponse
from django.shortcuts import render

# Create your views here.
from account.forms import LoginForm


def user_login(request):
    if request.method == 'POST':
        form = LoginForm(request.POST)
        if form.is_valid():
            cd = form.cleaned_data
            user = authenticate(
                username=cd['username'],
                password=cd['password'])
            if user is not None:
                if user.is_active:
                    login(request, user)
                    return HttpResponse('Authenticated successfully')
                else:
                    return HttpResponse('Disabled account')
            else:
                return HttpResponse('Invalid login')
    else:
        form = LoginForm()

    return render(request, 'account/login.html', {'form': form})
```

这就是基本的登录视图：当`user_login`调用*GET*请求，我们实例化一个新的登录表单`form = LoginForm()`并在模板中展示；当以*POST*提交时，执行如下操作：
1. 通过使用`form = LoginForm(request.POST)`提交的数据实例化表单。
1. 校验表单是否有效，如果无效则在模板中展示错误信息（例如未填写用户名就提交数据）。
1. 如果数据有效，使用`authenticate()`方法比对数据库来认证用户，此方法带入*username*和*password*，如果用户认证成功的话返回用户对象，否则为*None*。如果用户未认证通过，则返回`HttpResponse`展示信息。
1. 如果用户认证成功，我们再检查用户是否可用`is_active`，这是Django的*User*模型属性。如果用户不可用，则返回`HttpResponse`展示信息。
1. 若用户可用，则登录进入网站。通过调用`login()`将用户加入会话*session*并返回成功信息。

>注意：*authenticate*和*login*之间的不同之处：`authenticate()`检查用户认证信息，如果检查正确的话返回用户对象；`login()`添加用户到当前会话*session*中。

现在，我们为视图创建URL模式。在*account*应用中创建*urls.py*文件并加入如下代码：
```python
from django.conf.urls import url
from account import views


urlpatterns = [
    url(r'^login/$', views.user_login, name='login'),
]
```

编辑项目下的*urls.py*文件，将*account*应用添加到文件中：
```python
from django.conf.urls import url, include
from django.contrib import admin


urlpatterns = [
    url(r'^admin/', admin.site.urls),
    url(r'^account/', include('account.urls')),
]
```

现在可以访问登录视图了，现在我们来为视图创建相应的模板。之前我们没有为项目创建过模板，我们创建一个基础模板来用于供登录模板基础，在*account*应用下创建 *templates/base.html* 和 *templates/account/login.html* ：
```html
{% load staticfiles %}
<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}{% endblock %}</title>
    <link href="{% static "css/base.css" %}" rel="stylesheet"/>
</head>
<body>
<div id="header">
    <span class="logo">Bookmarks</span>
</div>
<div id="content">
    {% block content %}
    {% endblock %}
</div>
</body>
</html>
```

这是网站的基础模板，像之前的项目一样，在主模板中包含了*CSS*样式。在 *account/static/css* 目录下创建 *base.css* 文件。

现在，我们来为用户登录表单创建模板，打开 *account/login.html* 并添加如下代码：
```html
{% extends "base.html" %}

{% block title %}
    Login
{% endblock %}

{% block content %}
    <h1>Login</h1>
    <p>Please, use the following form to login:</p>
    <form action="." method="post">
        {{ form.as_p }}
        {% csrf_token %}
        <p><input type="submit" value="Login"/></p>
    </form>
{% endblock %}
```
这个模板包含了视图中被实例化的表单。因为我们要通过*POST*提交表单，所以包含了`{% csrf_token %}`模板标签来提供*CSRF*保护。我们已经在第二章中学习过*CSRF*。

现在我们还没有用户存在于数据库中，首先需要创建一个超级用户来管理站点并用于管理其他用户。
1. 使用命令并填写用户名、邮箱、密码：`python manage.py createsuperuser`
1. 部署网站并通过 *http://127.0.0.1:8000/admin* 访问：`python manage.py runserver`

我们访问 *http://127.0.0.1:8000/account/login/* 就可以看到我们的登录界面了。试着登录一下吧。如果登录成功的话会返回 *Authenticated successfully* ，否则返回 *Invalid login* 。

### 使用Django认证视图
### 登录和登出视图
### 修改密码视图
### 重置密码视图

## 用户注册和用户属性
### 用户注册
### 扩展用户模型
#### 使用自定义用户模型
### 使用消息框架
## 创建自定义的认证后台
## 为站点添加社交认证
### 使用Facebook认证
### 使用Twitter认证
### 使用Google认证
## 总结
