# Chapter 03 扩展博客应用


<!-- vim-markdown-toc GFM -->

* [创建自定义的标签和过滤器模板](#创建自定义的标签和过滤器模板)
	* [创建自定义的标签模板](#创建自定义的标签模板)
	* [创建自定义的过滤器模板](#创建自定义的过滤器模板)
* [给网站添加站点地图](#给网站添加站点地图)
* [给博客文章提供信息流](#给博客文章提供信息流)
* [使用Solr和Haystack添加搜索引擎](#使用solr和haystack添加搜索引擎)
	* [安装Solr](#安装solr)
	* [创建Solr core](#创建solr-core)
	* [安装Haystack](#安装haystack)
	* [构建索引](#构建索引)
	* [检索数据](#检索数据)
	* [创建查询视图](#创建查询视图)

<!-- vim-markdown-toc -->

## 创建自定义的标签和过滤器模板
本章将涵盖以下知识点：
- 创建自定义的标签和过滤器模板
- 添加站点地图和信息流
- 使用`Solr`和`Haystack`构建搜索引擎

### 创建自定义的标签模板
Django提供了许多内建的标签模板，例如`{% if %}`、`{% block %}`，我们已经在之前的模板中用了几次了。我们可以在[https://docs.djangoproject.com/en/1.8/ref/templates/builtins/](https://docs.djangoproject.com/en/1.8/ref/templates/builtins/)中找到内建标签和过滤器模板完整的参考。

当然，Django允许我们创建自己的标签模板来执行自定义的行为。当你需要在你的模板中添加功能而Django核心设置提供标签模板的时候，自定义模板会非常方便。

Django提供了以下帮助函数来允许我们以简单的方式来创建自己的标签模板：
- `simple_tag`: 处理数据并返回字符串
- `inclusion_tag`: 处理数据并返回渲染过的模板
- `assignment_tag`: 处理数据并在上下文中设置变量


在`blog`应用创建一个文件夹`templatetags`并且为其添加`___init__.py`文件。在该文件夹下再创建一个`blog_tags.py`文件。

文件名非常重要，模板将使用这些模块的名字加载你的标签。

我们创建一个简单的标签来获取博客中公开文章的总数。编辑刚才创建的文件`blog_tags.py`：
```python

from django import template

from blog.models import Post

register = template.Library()


@register.simple_tag
def total_post():
    return Post.published.count()
```
Django使用函数名作为标签名，如果想用不同的名称注册标签，可以通过`name`属性，例如`@register.simple_tag(name='my_tag')`。

`base.html`:
```html
{% load blog_tags %}
{% load staticfiles %}
<!DOCTYPE html>
<html>
<head>
<title>{% block title %}{% endblock %}</title>
<link href="{% static "css/blog.css" %}" rel="stylesheet">
</head>
<body>
<div id="content">
{% block content %}
{% endblock %}
</div>
<div id="sidebar">
<h2>My blog</h2>
<p>This is my blog. I've written {% total_posts %} posts so far.</
p>
</div>
</body>
</html>
```

现在，我们继续创建另一个标签，目的是在博客侧栏浏览最近的文章。这次我们使用`inclusion_tag`。继续编辑`blog_tags.py`文件：
```python
@register.inclusion_tag('blog/post/latest_post.html')
def show_latest_posts(count=5):
    latest_posts = Post.published.order_by('-publish')[:count]
    return {'latest_posts': latest_posts}
```
创建`blog/post/ and name it latest_posts.html`:
```html
<ul>
    {% for post in latest_posts %}
        <li>
            <a href="{{ post.get_absolute_url }}">{{ post.title }}</a>
        </li>
    {% endfor %}
</ul>
```
`base.html`:
```html
<div id="sidebar">
    <h2>My blog</h2>
    <p>This is my blog. I've written {% total_post %} posts so far.</p>
    <h3>Latest posts</h3>
    {% show_latest_posts 3 %}
</div>
```

最后，我们创建一个`assignment_tag`，浏览评论数最多的文章。
继续编辑`blog_tags.py`:
```python
@register.assignment_tag
def get_mount_commented_posts(count=5):
    return Post.published.annotate(total_comments=Count(
        'comments')).order_by('-total_comments')[:count]
```
除了`Count`之外，Django还提供了`Avg`,`Max`,`Min`和`Sum`等聚合函数。可以从[https://docs.djangoproject.com/en/1.8/topics/db/aggregation/](https://docs.djangoproject.com/en/1.8/topics/db/aggregation/)阅读更多关于聚合函数的内容。

继续编辑`base.html`，追加代码到侧边栏：
```html
<h3>Most commented posts</h3>
{% get_mount_commented_posts 4 as most_commented_posts %}
<ul>
    {% for post in most_commented_posts %}
        <li>
            <a href="{{ post.get_absolute_url }}">{{ post.title }}</a>
        </li>
    {% endfor %}
</ul>
```

我们可以在[https://docs.djangoproject.com/en/1.8/howto/custom-template-tags/](https://docs.djangoproject.com/en/1.8/howto/custom-template-tags/)阅读更多关于自定义标签模板的内容。

### 创建自定义的过滤器模板
Django拥有大量内建的允许在其中修改变量的过滤器模板，他们其实就是提供了一到两个参数的Python函数——一个是需要处理的变量值，一个是可选的参数。他们返回的值可以被展示或者被其他过滤器处理。过滤器类似`{{ variable | filter }}`，或者带上参数类似`{{ variable | my_filter:"foo" }}`，他们都会对之前的输出结果进行过滤。

我们创建自定义的过滤器，可以在博客文章中使用`markdown`语法，然后在模板中将文章内容转换为HTML。Markdown是一种非常易于使用的文本格式化语法并可以转换成HTML，我们可以在[https://daringfireball.net/projects/markdown/basics](https://daringfireball.net/projects/markdown/basics)学习其格式化的基础。

首先，安装`markdown`模块：
```
pip install markdown
```
然后编辑`blog_tags.py`并添加如下代码：
```python
from django.utils.safestring import mark_safe
import markdown

@register.filter(name='markdown')
def markdown_format(text):
	return mark_safe(markdown.markdown(text))
```

最后，加载标签模块到文章列表和文章详情的模板，添加下面这行到`post/list.html`和`/post/detail.html`模板顶部的`{% extends %}`标签后面：
```html
{% extends "blog/base.html" %}
{% load blog_tags %}
```
在`post/detail.html`中，用
```
{{ post.body|markdown }}
```
代替
```
{{ post.body|linebreaks }}
```

在`post/list.html`中，用
```
{{ post.body|markdown|truncatewords_html:30 }}
```
 代替
 ```
 {{ post.body|truncatewords:30|linebreaks }}
 ```

 正如我们所看到的，自定义过滤器模板对个性化格式是非常有用的。我们可以在[https://docs.djangoproject.com/en/1.8/howto/custom-template-tags/#writing-custom-template-filters](https://docs.djangoproject.com/en/1.8/howto/custom-template-tags/#writing-custom-template-filters)找到更多关于自定义过滤器的信息。

## 给网站添加站点地图
## 给博客文章提供信息流
## 使用Solr和Haystack添加搜索引擎 
### 安装Solr
### 创建Solr core
### 安装Haystack
### 构建索引
### 检索数据
### 创建查询视图

